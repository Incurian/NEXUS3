# GitLab CI/CD Configuration for NEXUS3
# Requires Python 3.11+. Uses the [ci] optional dependency group.
#
# Required CI/CD Variables (Settings > CI/CD > Variables):
#   - None required for tests
#   - PYPI_TOKEN: For publishing to PyPI (optional)

stages:
  - lint
  - test
  - build

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PYTHONDONTWRITEBYTECODE: "1"

# Cache pip downloads between jobs
cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - .cache/pip
    - .venv/

# Base template for Python jobs
.python-base:
  image: python:3.11-slim
  before_script:
    - python -m venv .venv
    - source .venv/bin/activate
    - pip install --upgrade pip
    - pip install -e ".[ci]"

# ============================================================================
# Lint Stage
# ============================================================================

ruff:
  extends: .python-base
  stage: lint
  script:
    - ruff check nexus3/
    - ruff format --check nexus3/
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

mypy:
  extends: .python-base
  stage: lint
  script:
    - mypy nexus3/
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  allow_failure: true  # Strict mode may have some issues initially

# ============================================================================
# Test Stage
# ============================================================================

test-unit:
  extends: .python-base
  stage: test
  script:
    - pytest tests/unit/ -v --cov=nexus3 --cov-report=xml --cov-report=term
  coverage: '/TOTAL.*\s+(\d+%)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    when: always
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

test-integration:
  extends: .python-base
  stage: test
  script:
    - pytest tests/integration/ -v
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

test-security:
  extends: .python-base
  stage: test
  script:
    - pytest tests/security/ -v
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Full test suite (manual trigger or tags)
test-all:
  extends: .python-base
  stage: test
  script:
    - pytest tests/ -v --cov=nexus3 --cov-report=html
  artifacts:
    paths:
      - htmlcov/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG
    - when: manual
      allow_failure: true

# Test on multiple Python versions
.test-matrix:
  stage: test
  parallel:
    matrix:
      - PYTHON_VERSION: ["3.11", "3.12", "3.13"]
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - python -m venv .venv
    - source .venv/bin/activate
    - pip install --upgrade pip
    - pip install -e ".[ci]"
  script:
    - pytest tests/unit/ -v
  rules:
    - if: $CI_COMMIT_TAG
    - when: manual
      allow_failure: true

# ============================================================================
# Build Stage
# ============================================================================

build-package:
  extends: .python-base
  stage: build
  script:
    - pip install build
    - python -m build
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Publish to PyPI (only on tags)
# publish-pypi:
#   extends: .python-base
#   stage: build
#   script:
#     - pip install twine
#     - python -m build
#     - twine upload dist/*
#   variables:
#     TWINE_USERNAME: __token__
#     TWINE_PASSWORD: $PYPI_TOKEN
#   rules:
#     - if: $CI_COMMIT_TAG
#   when: manual
